# ๐ FLUJO DE SEGURIDAD EN PETICIONES HTTP

## Diagrama de Flujo de una Peticiรณn Segura

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        CLIENTE (FRONTEND)                            โ
โ                    http://localhost:5173                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                      POST /api/auth/login
                    + usuario: "admin"
                    + password: "pass123"
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CAPA 1: HEADERS DE SEGURIDAD                       โ
โ  โ Helmet.js agrega headers automรกticos                             โ
โ     โข Content-Security-Policy                                        โ
โ     โข X-Frame-Options: DENY                                          โ
โ     โข X-Content-Type-Options: nosniff                                โ
โ     โข Strict-Transport-Security (HSTS)                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  CAPA 2: RATE LIMITING                                โ
โ  โ Express-rate-limit verifica:                                     โ
โ     โข IP origen: 192.168.1.100                                       โ
โ     โข Peticiones en รบltimos 15 min: 3/5                              โ
โ     โข Estado: โ PERMITIDO (aรบn no alcanzรณ lรญmite)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CAPA 3: CORS VALIDATION                            โ
โ  โ Valida origen:                                                   โ
โ     โข Origin header: http://localhost:5173                           โ
โ     โข Dominios permitidos: [localhost:5173, localhost:3000]          โ
โ     โข Estado: โ PERMITIDO                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 CAPA 4: BODY PARSING & VALIDATION                    โ
โ  โ Express.json() y validadores:                                    โ
โ     โข usuario: "admin" โ โ Vรกlido (string, length ok)               โ
โ     โข password: "pass123" โ โ Vรกlido (string, length ok)            โ
โ     โข Tamaรฑo payload: 1.2KB โ โ < 10MB limit                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              CAPA 5: INPUT SANITIZATION (SQL Injection)              โ
โ  โ sqlInjectionGuard detecta patrones maliciosos:                   โ
โ     โข Bรบsqueda: /UNION|SELECT|INSERT|DROP/gi                        โ
โ     โข Entrada "admin" โ โ Sin patrones maliciosos                    โ
โ     โข Entrada "admin'; DROP TABLE--" โ ๐ซ BLOQUEADO                  โ
โ     โข Estado: โ SEGURO                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
            Llama a: authController.login()
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  CAPA 6: AUTENTICACIรN                                โ
โ  โ Busca usuario en BD:                                             โ
โ     SELECT * FROM usuarios WHERE usuario = $1 AND activo = true    โ
โ     Resultado: Usuario encontrado โ                                  โ
โ                                                                      โ
โ  โ Compara contraseรฑa con bcryptjs:                                โ
โ     bcryptjs.compare("pass123", hash_almacenado)                    โ
โ     Resultado: โ COINCIDE                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   CAPA 7: TOKEN GENERATION                            โ
โ  โ jwt.sign() genera tokens:                                        โ
โ     Payload:                                                         โ
โ     {                                                                โ
โ       userId: 1,                                                     โ
โ       usuario: "admin",                                              โ
โ       rol: "admin"                                                   โ
โ     }                                                                โ
โ                                                                      โ
โ     Opciones:                                                        โ
โ     โข Secreto: JWT_SECRET (32+ caracteres)                           โ
โ     โข Expiraciรณn: 1h                                                 โ
โ     โข Algoritmo: HS256                                               โ
โ                                                                      โ
โ     JWT generado: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  CAPA 8: LOGGING & AUDIT                             โ
โ  โ Winston Logger registra:                                         โ
โ     [2025-12-21T10:30:45] INFO - Login exitoso                      โ
โ     userId: 1                                                        โ
โ     usuario: admin                                                   โ
โ     ip: 192.168.1.100                                                โ
โ     userAgent: Mozilla/5.0...                                        โ
โ     timestamp: 2025-12-21T10:30:45.123Z                              โ
โ                                                                      โ
โ     Archivo: logs/app.log                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                    HTTP 200 OK RESPONSE
                {
                  "token": "eyJhbGciOiJIUzI1NiIs...",
                  "usuario": {
                    "id": 1,
                    "usuario": "admin",
                    "rol": "admin"
                  }
                }
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CLIENTE RECIBE TOKEN                              โ
โ  โ Frontend guarda token en localStorage                            โ
โ  โ Prรณximas peticiones incluyen:                                    โ
โ     Authorization: Bearer eyJhbGciOiJIUzI1NiIs...                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Flujo de una Peticiรณn Protegida

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        CLIENTE (FRONTEND)                            โ
โ                    GET /api/hojas-ruta                               โ
โ              Headers: Authorization: Bearer <token>                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CAPA 1: HEADERS SEGURIDAD                         โ
โ  โ Helmet.js aplica headers                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CAPA 2: RATE LIMITING                             โ
โ  โ Verifica lรญmite global (100 req/15 min)                          โ
โ     Estado: 45/100 โ โ PERMITIDO                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CAPA 3: CORS VALIDATION                           โ
โ  โ Origen: http://localhost:5173 โ โ PERMITIDO                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         CAPA 4: MIDDLEWARE - authenticateToken()                     โ
โ  โ Lee header Authorization: Bearer <token>                         โ
โ  โ Extrae token de la cadena                                        โ
โ  โ Valida formato Bearer (case-sensitive)                           โ
โ                                                                      โ
โ  โ Casos de error:                                                   โ
โ     โข Sin token โ 401 "Token de acceso requerido"                   โ
โ     โข Formato mal โ 401 "Formato invรกlido (use Bearer <token>)"     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            CAPA 5: JWT VERIFICATION - jwt.verify()                   โ
โ  โ Verifica firma del token:                                        โ
โ     โข Secreto: JWT_SECRET                                            โ
โ     โข Algoritmo: HS256                                               โ
โ     โข Valida: signature = HMAC(header.payload, secret)               โ
โ                                                                      โ
โ  โ Casos de error:                                                   โ
โ     โข Token corrupto โ 403 "Token invรกlido"                         โ
โ     โข Expirado โ 401 "Token expirado"                               โ
โ     โข Secreto no coincide โ 403 "Token invรกlido"                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           CAPA 6: TOKEN PAYLOAD VALIDATION                           โ
โ  โ Extrae payload:                                                  โ
โ     {                                                                โ
โ       userId: 1,                                                     โ
โ       usuario: "admin",                                              โ
โ       rol: "admin",                                                  โ
โ       iat: 1703153445,  // Issued at                                 โ
โ       exp: 1703157045   // Expiration (3600s = 1h)                   โ
โ     }                                                                โ
โ                                                                      โ
โ  โ Asigna al request:                                               โ
โ     req.userId = 1                                                   โ
โ     req.userRole = "admin"                                           โ
โ     req.tokenExp = 1703157045                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         CAPA 7: AUTHORIZATION - requireReadAccess()                  โ
โ  โ Verifica permisos:                                               โ
โ     โข req.userRole = "admin" โ En ['desarrollador', 'admin']?       โ
โ     โข Estado: โ Sร, tiene permisos de lectura                       โ
โ                                                                      โ
โ  โ Casos de error:                                                   โ
โ     โข userRole = "usuario" โ 403 "No tienes permisos"              โ
โ     โข No autenticado โ 401 "Usuario no autenticado"                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ             CAPA 8: QUERY VALIDATION - validateListQuery()           โ
โ  โ Valida parรกmetros de bรบsqueda:                                   โ
โ     query (opcional): length โค 255 โ                               โ
โ     estado (opcional): en ['pendiente', 'en_proceso', ...] โ       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
            Llama a: hojasRutaController.listarHojasRuta()
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            CAPA 9: DATABASE QUERY CONSTRUCTION                       โ
โ  โ Construye query parameterizada:                                  โ
โ     SELECT * FROM hojas_ruta                                         โ
โ     WHERE 1=1 AND numero_hr ILIKE $1 ...                             โ
โ     ORDER BY dias_para_vencimiento ASC                               โ
โ                                                                      โ
โ  โ Parรกmetros: ['%busqueda%', ...]                                 โ
โ     โ Previene SQL Injection automรกticamente                         โ
โ     โ PostgreSQL sanitiza los valores                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  CAPA 10: SECURITY LOGGING                           โ
โ  โ Winston Logger registra:                                         โ
โ     [2025-12-21T10:31:20] INFO - Peticiรณn HTTP completada            โ
โ     method: GET                                                      โ
โ     path: /api/hojas-ruta                                            โ
โ     statusCode: 200                                                  โ
โ     duration: 125ms                                                  โ
โ     userId: 1                                                        โ
โ     ip: 192.168.1.100                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                      HTTP 200 OK RESPONSE
                [
                  {
                    "id": 1,
                    "numero_hr": "HR-001",
                    "referencia": "Documento importante",
                    ...
                  }
                ]
```

---

## ๐ซ Flujo de un Ataque SQL Injection Bloqueado

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        ATACANTE INTENTA:                             โ
โ              /api/hojas-ruta?query=HR'; DROP TABLE--                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              CAPA 4: sqlInjectionGuard() DETECTA                      โ
โ  โ Bรบsqueda REGEX: /DROP/gi en valor                                 โ
โ  โ Bรบsqueda REGEX: /--/gi en valor                                   โ
โ  โ Patrรณn sospechoso detectado                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
              BLOQUEADO: HTTP 400 Bad Request
                {
                  "error": "Datos de entrada sospechosos",
                  "code": "SUSPICIOUS_INPUT"
                }
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         CAPA 10: SECURITY LOGGING - Intento Registrado               โ
โ  โ๏ธ  Winston Logger registra:                                        โ
โ     [2025-12-21T10:32:00] WARN - Posible ataque detectado            โ
โ     type: sqlInjection                                               โ
โ     path: /api/hojas-ruta                                            โ
โ     input: "HR'; DROP TABLE--"                                       โ
โ     ip: 203.0.113.45                                                 โ
โ     userAgent: Mozilla/5.0 (intento)                                 โ
โ                                                                      โ
โ     Archivo: logs/error.log y logs/app.log                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Resumen de Capas de Seguridad

| # | Capa | Funciรณn | Status |
|---|------|---------|--------|
| 1 | Headers HTTP | Helmet.js | โ |
| 2 | Rate Limiting | express-rate-limit | โ |
| 3 | CORS | express.cors | โ |
| 4 | Body Parsing | express.json | โ |
| 5 | SQL Injection Guard | sqlInjectionGuard | โ |
| 6 | Input Validation | express-validator | โ |
| 7 | Authentication | JWT verify | โ |
| 8 | Authorization | Roles & Permissions | โ |
| 9 | Database Query | Parรกmetros preparados | โ |
| 10 | Security Logging | Winston Logger | โ |

---

## ๐ Tiempo de Procesamiento

```
Peticiรณn exitosa:
  Headers seguridad:      1-2ms
  Rate limiting:          1-2ms
  CORS validation:        1-2ms
  Body parsing:           1-3ms
  Input validation:       2-5ms
  SQL injection guard:    1-2ms
  JWT verification:       2-5ms
  DB query:              20-50ms
  Response:              1-2ms
  โโโโโโโโโโโโโโโโโ
  TOTAL:                ~35-75ms
```

---

## ๐ฏ Conclusiรณn

Cada peticiรณn HTTP pasa por **10 capas de seguridad** antes de ser procesada, asegurando:

โ Protecciรณn contra SQL Injection  
โ Protecciรณn contra DoS  
โ Validaciรณn de autenticaciรณn  
โ Control de autorizaciรณn  
โ Validaciรณn de entrada  
โ Logging y auditorรญa  
โ Headers seguros  

**ยกSistema completamente protegido!**
